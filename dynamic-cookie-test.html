<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>���� ������������ Cookie �������</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; }
        .success { background: #d4edda; color: #155724; border-left-color: #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }
        button { padding: 12px 20px; margin: 8px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; border: 1px solid #dee2e6; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e9ecef; }
        .real-time { background: #fff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .indicator.green { background: #28a745; }
        .indicator.red { background: #dc3545; }
        .indicator.yellow { background: #ffc107; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>?? ����������� ���������� Cookie �������</h1>
    
    <div class="real-time">
        <h3>?? ������ � �������� �������</h3>
        <div id="real-time-status">
            <div><span class="indicator yellow" id="cookie-indicator"></span>Cookie: <span id="cookie-status">��������...</span></div>
            <div><span class="indicator yellow" id="banner-indicator"></span>������: <span id="banner-status">��������...</span></div>
            <div><span class="indicator yellow" id="yandex-indicator"></span>������.�������: <span id="yandex-status">��������...</span></div>
            <div><span class="indicator yellow" id="google-indicator"></span>Google Analytics: <span id="google-status">��������...</span></div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>?? ������������ �������</h3>
            <button onclick="runFullTest()">?? ��������� ������ ����</button>
            <button onclick="testCookieBanner()" class="success">?? ����������� ������</button>
            <button onclick="testAnalytics()">?? ����������� ���������</button>
            <button onclick="simulateUserFlow()">?? ������������ ������������</button>
            <button onclick="clearAllData()" class="danger">??? �������� ��� ������</button>
        </div>
        
        <div class="card">
            <h3>?? ���������� ������</h3>
            <div id="test-results">
                <div class="status info">������� "��������� ������ ����" ��� ������ ��������</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>?? ��������� �����������</h3>
        <div id="detailed-info">
            <h4>Cookie ������:</h4>
            <div id="cookie-details"></div>
            
            <h4>������� �������:</h4>
            <div id="network-details"></div>
            
            <h4>JavaScript ������:</h4>
            <div id="error-details"></div>
        </div>
    </div>

    <div class="card">
        <h3>?? ���������� ����������</h3>
        <pre id="debug-info">�������� ���������� ����������...</pre>
    </div>

    <div class="card">
        <h3>?? ��������� ���������� ������������</h3>
        <ol>
            <li><strong>�������� ������:</strong> ������� "�������� ��� ������"</li>
            <li><strong>�������� ��������:</strong> F5 ��� ��������� ������ ������������</li>
            <li><strong>��������� ������:</strong> ������ ��������� ����� 1 �������</li>
            <li><strong>������� "�������":</strong> ��������� ���������� cookie</li>
            <li><strong>��������� ���������:</strong> ������ ����������� ������� ������</li>
            <li><strong>��������� �������:</strong> ��������� �������� �������</li>
        </ol>
    </div>

    <script src="cookie-consent.js"></script>
    
    <script>
        // ���������� ���������� ��� ������������
        let testResults = [];
        let networkRequests = [];
        let jsErrors = [];

        // �������� ������� ��������
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && (url.includes('yandex') || url.includes('google') || url.includes('gtag'))) {
                networkRequests.push({
                    url: url,
                    timestamp: new Date().toISOString(),
                    type: 'fetch'
                });
                updateNetworkDetails();
            }
            return originalFetch.apply(this, args);
        };

        // �������� ������
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('cookie-consent')) {
                jsErrors.push({
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    timestamp: new Date().toISOString()
                });
                updateErrorDetails();
            }
        });

        function addTestResult(test, status, message) {
            testResults.push({
                test: test,
                status: status,
                message: message,
                timestamp: new Date().toISOString()
            });
            updateTestResults();
        }

        function updateIndicator(indicatorId, status) {
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.className = `indicator ${status}`;
            }
        }

        function updateRealTimeStatus() {
            // Cookie ������
            const hasConsent = document.cookie.includes('cookie_consent=all');
            const cookieStatus = document.getElementById('cookie-status');
            if (hasConsent) {
                cookieStatus.textContent = '�������� ��������';
                updateIndicator('cookie-indicator', 'green');
            } else {
                cookieStatus.textContent = '�������� �� ��������';
                updateIndicator('cookie-indicator', 'red');
            }

            // ������ ������
            const banner = document.getElementById('cookie-banner');
            const bannerStatus = document.getElementById('banner-status');
            if (banner) {
                const isVisible = banner.style.visibility === 'visible' && banner.style.opacity === '1';
                if (isVisible) {
                    bannerStatus.textContent = '�����';
                    updateIndicator('banner-indicator', 'green');
                } else {
                    bannerStatus.textContent = '�����';
                    updateIndicator('banner-indicator', 'yellow');
                }
            } else {
                bannerStatus.textContent = '�� ������';
                updateIndicator('banner-indicator', 'red');
            }

            // ������.������� ������
            const yandexStatus = document.getElementById('yandex-status');
            if (typeof window.ym !== 'undefined') {
                yandexStatus.textContent = '���������';
                updateIndicator('yandex-indicator', 'green');
            } else {
                yandexStatus.textContent = '�� ���������';
                updateIndicator('yandex-indicator', 'red');
            }

            // Google Analytics ������
            const googleStatus = document.getElementById('google-status');
            if (typeof window.gtag !== 'undefined') {
                googleStatus.textContent = '��������';
                updateIndicator('google-indicator', 'green');
            } else {
                googleStatus.textContent = '�� ��������';
                updateIndicator('google-indicator', 'red');
            }
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            const html = testResults.map(result => {
                const statusClass = result.status === 'success' ? 'success' : 
                                 result.status === 'error' ? 'error' : 'warning';
                const icon = result.status === 'success' ? '?' : 
                           result.status === 'error' ? '?' : '??';
                return `<div class="status ${statusClass}">${icon} <strong>${result.test}:</strong> ${result.message}</div>`;
            }).reverse().join('');
            resultsDiv.innerHTML = html || '<div class="status info">����� ��� �� ��������</div>';
        }

        function updateCookieDetails() {
            const details = document.getElementById('cookie-details');
            const cookies = document.cookie.split(';').map(c => c.trim()).filter(c => c);
            details.innerHTML = `
                <p><strong>����� cookie:</strong> ${cookies.length}</p>
                <p><strong>Cookie ��������:</strong> ${document.cookie.includes('cookie_consent=all') ? '? �����������' : '? �����������'}</p>
                <p><strong>������������� cookie:</strong></p>
                <ul>
                    <li>_ym_uid: ${document.cookie.includes('_ym_uid') ? '?' : '?'}</li>
                    <li>_ga: ${document.cookie.includes('_ga') ? '?' : '?'}</li>
                    <li>_gid: ${document.cookie.includes('_gid') ? '?' : '?'}</li>
                </ul>
                <p><strong>��� cookie:</strong></p>
                <pre style="font-size: 10px;">${document.cookie || '(�����)'}</pre>
            `;
        }

        function updateNetworkDetails() {
            const details = document.getElementById('network-details');
            const html = networkRequests.map(req => 
                `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                    <strong>${req.type.toUpperCase()}:</strong> ${req.url}<br>
                    <small>${req.timestamp}</small>
                </div>`
            ).join('');
            details.innerHTML = html || '<p>������� �������� � ��������� ���� ���</p>';
        }

        function updateErrorDetails() {
            const details = document.getElementById('error-details');
            const html = jsErrors.map(error => 
                `<div style="margin: 5px 0; padding: 5px; background: #f8d7da; border-radius: 4px;">
                    <strong>������:</strong> ${error.message}<br>
                    <strong>����:</strong> ${error.filename}:${error.lineno}<br>
                    <small>${error.timestamp}</small>
                </div>`
            ).join('');
            details.innerHTML = html || '<p>������ JavaScript �� ����������</p>';
        }

        function updateDebugInfo() {
            const debugInfo = {
                '����� ��������': new Date().toISOString(),
                'URL ��������': window.location.href,
                'User Agent': navigator.userAgent,
                'Cookie ��������': document.cookie.includes('cookie_consent=all'),
                '������.������� (ym)': typeof window.ym !== 'undefined',
                'Google Analytics (gtag)': typeof window.gtag !== 'undefined',
                'DataLayer': typeof window.dataLayer !== 'undefined',
                '������ � DOM': !!document.getElementById('cookie-banner'),
                '����� cookie': document.cookie.split(';').filter(c => c.trim()).length,
                '������� �������': networkRequests.length,
                'JavaScript ������': jsErrors.length
            };
            
            document.getElementById('debug-info').textContent = JSON.stringify(debugInfo, null, 2);
        }

        function testCookieBanner() {
            addTestResult('���� �������', 'info', '������ ������������ �������...');
            
            // ��������� �������� �������
            setTimeout(() => {
                const banner = document.getElementById('cookie-banner');
                if (banner) {
                    addTestResult('�������� �������', 'success', '������ ������� ������ � DOM');
                    
                    // ��������� ���������
                    const isVisible = banner.style.visibility === 'visible' && banner.style.opacity === '1';
                    if (isVisible) {
                        addTestResult('��������� �������', 'success', '������ ����� �� ��������');
                    } else {
                        addTestResult('��������� �������', 'warning', '������ ������, �� �� �����');
                    }
                    
                    // ��������� ������
                    const button = document.getElementById('cookie-accept');
                    if (button) {
                        addTestResult('������ "�������"', 'success', '������ ������� � ��������');
                    } else {
                        addTestResult('������ "�������"', 'error', '������ �� �������');
                    }
                } else {
                    addTestResult('�������� �������', 'error', '������ �� ������');
                }
            }, 2000);
        }

        function testAnalytics() {
            addTestResult('���� ���������', 'info', '������ ������������ ���������...');
            
            setTimeout(() => {
                // ��������� ������.�������
                if (typeof window.ym !== 'undefined') {
                    addTestResult('������.�������', 'success', '������ ������.������� ��������');
                    
                    try {
                        window.ym(106225686, 'hit', window.location.href, {
                            title: '���� ������������ �������',
                            referer: document.referrer
                        });
                        addTestResult('������.������� hit', 'success', '�������� hit ���������');
                    } catch (e) {
                        addTestResult('������.������� hit', 'error', `������: ${e.message}`);
                    }
                } else {
                    addTestResult('������.�������', 'error', '������ ������.������� �� ��������');
                }
                
                // ��������� Google Analytics
                if (typeof window.gtag !== 'undefined') {
                    addTestResult('Google Analytics', 'success', '������ Google Analytics ��������');
                    
                    try {
                        window.gtag('event', 'test_dynamic_system', {
                            'event_category': 'debug',
                            'event_label': 'cookie_test'
                        });
                        addTestResult('Google Analytics event', 'success', '�������� ������� ����������');
                    } catch (e) {
                        addTestResult('Google Analytics event', 'error', `������: ${e.message}`);
                    }
                } else {
                    addTestResult('Google Analytics', 'error', '������ Google Analytics �� ��������');
                }
            }, 1000);
        }

        function simulateUserFlow() {
            addTestResult('��������� ������������', 'info', '������ ��������� ������� �����...');
            
            // ��� 1: ������� cookie
            document.cookie = 'cookie_consent=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            addTestResult('������� cookie', 'success', 'Cookie �������');
            
            // ��� 2: ������������ ���������
            setTimeout(() => {
                // ��������� ��������� �������
                if (typeof showCookieBanner === 'function') {
                    showCookieBanner();
                    addTestResult('����� �������', 'success', '������ �������');
                }
                
                // ��� 3: ��������� ����� �� "�������"
                setTimeout(() => {
                    const button = document.getElementById('cookie-accept');
                    if (button) {
                        button.click();
                        addTestResult('���� �� "�������"', 'success', '��������� ���� �� ������');
                        
                        // ��� 4: �������� �����������
                        setTimeout(() => {
                            const hasConsent = document.cookie.includes('cookie_consent=all');
                            if (hasConsent) {
                                addTestResult('���������� cookie', 'success', 'Cookie �������� ���������');
                            } else {
                                addTestResult('���������� cookie', 'error', 'Cookie �������� �� ���������');
                            }
                            
                            testAnalytics();
                        }, 1000);
                    } else {
                        addTestResult('���� �� "�������"', 'error', '������ �� �������');
                    }
                }, 2000);
            }, 1000);
        }

        function runFullTest() {
            addTestResult('������ ����', 'info', '������ ����������� �������� �������...');
            testCookieBanner();
            setTimeout(() => testAnalytics(), 3000);
            setTimeout(() => updateAllDetails(), 5000);
        }

        function clearAllData() {
            document.cookie = 'cookie_consent=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = '_ym_uid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = '_ym_d=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = '_ga=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = '_gid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // ������� ������ ���� ����
            const banner = document.getElementById('cookie-banner');
            if (banner) {
                banner.remove();
            }
            
            addTestResult('������� ������', 'success', '��� ������ �������');
            setTimeout(() => window.location.reload(), 1000);
        }

        function updateAllDetails() {
            updateCookieDetails();
            updateNetworkDetails();
            updateErrorDetails();
            updateDebugInfo();
        }

        // ������������� � ��������������
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateRealTimeStatus();
                updateAllDetails();
                addTestResult('�������������', 'success', '������� ������������ ������');
            }, 1500);
            
            // �������������� ������� ������ 2 �������
            setInterval(updateRealTimeStatus, 2000);
            
            // �������������� ������� ������ 5 ������
            setInterval(updateAllDetails, 5000);
        });
    </script>
</body>
</html>


